
# 作用

提供端到端的进程间逻辑通信服务



# 传输协议

传输层的数据叫做段，网络层的数据叫作包。数据链路层的数据叫做帧，物理层的数据叫作流。

可靠传输协议：ARQ协议，通过确认和超时两个机制

现在能够在不可靠的网络中传输可靠的数据，由于带宽是有限的，接收方的负载也是有限制的，所以引入窗口协议，做流量控制。

窗口协议有两种：
1、拥塞窗口
慢启动、退半避让、快重传、快恢复。

2、滑动窗口

接收方告知发送方自己可以接受缓冲区的大小，通常与ARQ协议一起使用（确认和超时机制）


TCP协议是面向连接的协议，在数据传输前通过三次握手建立连接，传输完成后通过四次挥手断开连接，整个过程表示一次完整的数据传输，所以需要4位头长告知哪些是正在传输的数据。

UDP协议是无连接的，两次数据传输没有任何联系，所以需要16位长度告知本次传输的数据有多少。同时注意，UDP协议每次传输的数据量并不是2^16 - 1 - 8 - 20（8表示UDP头长，20表示IP头长），而是与MTU有关，即数据链路层的最大传输单元(Maximum Transmission Unit)，值是1500。

MTU—数据链路层的最大传输单元




# TCP可靠性保证

1、确认和重传：接收方收到报文就会确认，发送方发送一段时间后没有收到确认就重传。


4、流量控制：当接收方来不及处理发送方的数据，能提示发送方降低发送的速率，防止包丢失。
5、拥塞控制：当网络拥塞时，减少数据的发送。


TCP将数据分解成[网路封包](https://zh.wikipedia.org/wiki/%E7%B6%B2%E8%B7%AF%E5%B0%81%E5%8C%85 "网路封包")，并在每个数据包中添加少量数据。这些附加数据包括一个序列号，用于检测丢失或到达顺序不正确的数据包，以及一个[校验和](https://zh.wikipedia.org/wiki/%E6%A0%A1%E9%AA%8C%E5%92%8C "校验和")，可以检测数据包数据内的错误。当其中任何一个问题发生时，TCP使用[自动重传请求](https://zh.wikipedia.org/wiki/%E8%87%AA%E5%8A%A8%E9%87%8D%E4%BC%A0%E8%AF%B7%E6%B1%82 "自动重传请求")（ARQ）告诉发送方重新发送丢失或损坏的数据包[[19]](https://zh.wikipedia.org/zh-hans/QUIC#cite_note-ARSnext-19)。





## 基于UDP的可靠性传输

## KCP协议的特征

KCP是一个快速可靠性协议，能以比TCP浪费10%~20%的带宽代价，获取平均延迟降低30%~40%。且最大延迟降低三倍的传输效果，纯算法实现，并不负责底层协议（如UDP）的收发，需要使用者自己定义下层数据的发送方式，以 callback的方式提供给 KCP。连时钟都需要外部传递进来，内部不会有任何一次系统调用。  

TCP是为流量设计的（每秒内可以传输多少KB的数据），讲究的是充分利用带宽。而 KCP是为流速设计的（单个数据从一端发送到一端需要多少时间），以10%-20%带宽浪费的代价换取了比 TCP快30%-40%的传输速度。


## QUIC 协议

特点：

1）重传机制
	每个QUIC流式单独控制着，这意味着重传机制的保证是由QUIC所在的应用层保证，而不是UDP级别，意味着一旦其中一个流发生错误，协议栈依然可以独立地继续为其他流提供服务。这样提高易出错链路的性能方面非常有用，因为在大多数情况下TCP协议通知数据包丢失或者损坏之前可能受到大量正常的数据，但是在纠错之前其他正常的请求会等待甚至重发。QUIC在修复单个流时可以自由处理其他数据，也就是说即使一个请求发生了错误也不会影响到其他的请求
	
2）提高网络切换期间的性能

3）QUIC在应用层实现，而不是在内核态实现，这样也会降低上下文切换带来的额外开销



QUIC包括许多其他更普通的更改，这些更改也可以优化整体延迟和[吞吐量](https://zh.wikipedia.org/wiki/%E5%90%9E%E5%90%90%E9%87%8F "吞吐量")。例如，每个数据包是单独加密的，因此加密数据时不需要等待部分数据包。 在TCP下通常不可能这样做，其中加密记录在[字节流](https://zh.wikipedia.org/wiki/%E5%AD%97%E7%AF%80%E6%B5%81 "字节流")中，并且协议栈不知道该流中的更高层边界。这些可以由运行在更上层的协议进行协商，但QUIC旨在通过单个握手过程完成这些。



4）因此 QUIC 实现了自己的流量控制机制



# 拥塞控制算法



TCP拥塞控制算法的目的可以简单概括为：公平竞争、充分利用网络带宽、降低网络延时、优化用户体验，然而就目前而言要实现这些目标就难免有权衡和取舍。



拥塞控制是一个动态的过程，它既要提高带宽利用率发送尽量多的数据又要避免网络拥堵丢包RTT增大等问题，基于这种高要求并不是单一策略可以搞定的，因此TCP的拥塞控制策略实际上是分阶段分策略的综合过程：


## bbr算法

https://www.51cto.com/article/685201.html

BBR算法是个主动的闭环反馈系统，通俗来说就是根据带宽和RTT延时（往返延迟，表示从发送端发送数据开始，到发送端收到来自接收端的确认（接收端收到数据后便立即发送确认），总共经历的时延，所以RTT的变化在一定程度上反映了网络拥塞程度的变化。）来不断动态探索寻找合适的发送速率和发送量。



根据当前最大网络带宽和最小时延，不断动态去寻找当前最合适的发送速率和发送量。

并于2016年发布的拥塞算法，相比对以往大部分拥塞算法是**基于丢包**来作为降低传输速率的信号，而BBR基于模型主动探测。

该算法使用网络最近出站数据分组当时的最大带宽和往返时间来创建网络的显式模型。数据包传输的每个累积或选择性确认用于生成记录在数据包传输过程和确认返回期间的时间内所传送数据量的采样率。