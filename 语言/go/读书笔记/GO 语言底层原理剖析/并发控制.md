协议优化退出的context、检查并发数据争用的race工具、传统的同步原语——锁

# context

使用context更为重要的一点是协程之间尝存在着级联关系，退出需要传递性。

context的传播关系是父context的退出会导致所有子context的退出，而子context的退出并不会影响父context。



# 数据争用检查

矢量时钟技术

用于检测和确定分布式系统中事件的因果关系。

矢量时钟（Vector Clock）是一种在分布式系统中用来解决时间戳一致性问题的技术。在分布式系统中，每个节点都有自己的本地时钟，但是由于时钟误差、延迟等原因，不同节点的本地时钟并不一定同步，导致不同节点看到的事件顺序可能是不同的。为了解决这个问题，可以使用矢量时钟技术来保证分布式系统中的事件顺序一致

矢量时钟将每个节点的时钟信息表示为一个矢量，矢量中的每个元素表示一个节点的时钟值，矢量的长度等于节点的数量。每个节点在产生一个事件时，会将自己的矢量时钟发送给其他节点，并在接收到其他节点的矢量时钟时，根据这些矢量时钟来更新自己的矢量时钟。通过这种方式，不同节点的矢量时钟会逐渐趋于一致，从而可以确定事件发生的顺序。

在GO语言中，每个协程在创建之初都会初始化矢量时钟，并在读取事件时候修改自己的逻辑始终。

# 锁

需要一些机制来保证某一个时刻只能有一个协程执行特定操作，从而实现happened-before.

什么是happened-before？

指在多个操作中，如果操作 A Happens-before 操作 B，那么操作 A 的结果将对操作 B 是可见的，也就是说操作 A 对操作 B 具有影响。 针对共享的数据，两个协程之间的操作需要有先后性。

## 原子性

count++ 操作并非原子性的，底层经历了读取数据、更新CPU缓存、存入内存这一些操作。

当然还有一些代码在编译器(编译时)和CPU处理器(在运行时)通过调整指令顺序进行优化。因此一些执行顺序和代码的显示不同。

这种需要硬件支持，比如x86指令集中的LOCK指令，对应Go语言中的sync/atomic 包

原子操作是底层最基础的同步保证，通过原子操作可以构建起许多同步原语，比如：自旋锁、互斥锁、信号量等。


## 互斥锁

Go语言拥有比线程更加轻量级别的协程，在协程的基础上实现了一种比传统操作系统级别的锁更加轻量级的互斥锁。

### 互斥锁实现原理

```
type Mutex struct{
// 位图的形式存储了当前锁的状态，包含锁是否被锁定状态、正在等待被唤醒的协程数量、两个和饥饿有关的标志位
  state unit32 
  sema uint32 // 互斥锁中实现的信号量
}
```

state使用位图的形式存储了当前锁的状态，其中包含锁是否为锁定状态、正在等待被锁唤醒的协程数量、两个和饥饿模式有关的标志。

为了解决某一个协程可能长时间无法获取锁的问题，G1.9之后使用了饥饿模式。在饥饿模式下，unlock会唤醒最先申请加速的协程，从而保证公平性。

互斥锁会经历三个阶段：
1）阶段1：使用原子操作快速抢占锁，如果抢占成功则立即返回，否则进入lockslow方法，当锁在正常状态的时候，进入自旋状态：
      lockslow方法在正常情况下会自旋尝试抢锁一段时间，这使得互斥锁在频繁加锁和释放锁时候也能良好工作。
  遇到下面的四种情况，自旋状态立马终止：
  1）程序在单核CPU上执行
  2）逻辑处理器P小于或者等于1
  3）当前协程所在的逻辑处理器P的本地队列中有其他的协程等待执行
  4）自旋的此时超过了阈值。阈值是30次
      

2）阶段2：
   自选阶段退出后，使用信号量进行同步，
当信号量=0，意味着当前加锁协程需要进入陷入休眠节点，进入阶段3

3）阶段3：
所以锁的信息会根据锁的地址存储在一个全局semtable哈希表中，当前会出现锁地址的冲突，那么使用一个双向链表进行存储，链表是特殊的treap树。引入的随机数以及必要时的选择保证了比较好的平衡性。

什么是treap树？

Treap树是一种随机化的二叉搜索树，它同时满足二叉搜索树的查找、插入和删除操作的期望时间复杂度为 O(log n) 和堆的期望深度为 O(log n)，其中 n 表示树中节点的个数。它将节点按照二叉搜索树的规则排序，同时每个节点都附有一个随机产生的优先级，通过维护节点的优先级来保证树的堆特性。


如果已经查找到该锁，则将当前的协程添加到等待队列的队尾。否则新增加一个元素。

但是在访问哈希表的时候，还是可能会面临并发的数据争取。依旧使用锁进行，这里的锁是先自旋一定次数，如果还没有获取到锁，则调用操作系统级别的锁。

锁被放置到全局的等待队列中并等待被唤醒，唤醒的顺序从前到后，遵循先入后出的准则，来保证公平性。



